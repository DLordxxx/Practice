// Проверяет уникальность даты и времени в документах НаправлениеНаПересдачу и ИндивидуальныйПланЛиквидацииЗадолженностей
&НаСервере
Процедура ПроверитьУникальностьДатыИВремени(ТипДокумента, Дата, Время, Аудитория, Ссылка, Отказ) Экспорт
    
    Отказ = Ложь;
    
    // Проверяем оба типа документов
    ТипыДляПроверки = Новый Массив;
    ТипыДляПроверки.Добавить("НаправлениеНаПересдачу");
    ТипыДляПроверки.Добавить("ИндивидуальныйПланЛиквидацииЗадолженностей");
    
    Для Каждого ТекущийТип Из ТипыДляПроверки Цикл
        Запрос = Новый Запрос;
        
        Если ТекущийТип = "НаправлениеНаПересдачу" Тогда
            Запрос.Текст =
            "ВЫБРАТЬ
            |   НаправлениеНаПересдачу.Ссылка КАК Ссылка
            |ИЗ
            |   Документ.НаправлениеНаПересдачу КАК НаправлениеНаПересдачу
            |ГДЕ
            |   НаправлениеНаПересдачу.ДатаПроведения = &Дата
            |   И НаправлениеНаПересдачу.Время = &Время
            |   И НаправлениеНаПересдачу.Аудитория = &Аудитория
            |   И НЕ НаправлениеНаПересдачу.ПометкаУдаления
            |   И НаправлениеНаПересдачу.Проведен = ИСТИНА";
            
            // Для документов того же типа исключаем текущий документ из проверки
            Если ТипДокумента = "НаправлениеНаПересдачу" Тогда
                Запрос.Текст = Запрос.Текст + "
                |   И НаправлениеНаПересдачу.Ссылка <> &Ссылка";
            КонецЕсли;
            
        ИначеЕсли ТекущийТип = "ИндивидуальныйПланЛиквидацииЗадолженностей" Тогда
            Запрос.Текст =
            "ВЫБРАТЬ
            |   ИндивидуальныйПланЛиквидацииЗадолженностей.Ссылка КАК Ссылка
            |ИЗ
            |   Документ.ИндивидуальныйПланЛиквидацииЗадолженностей КАК ИндивидуальныйПланЛиквидацииЗадолженностей
            |ГДЕ
            |   ИндивидуальныйПланЛиквидацииЗадолженностей.ДатаПересдачи = &Дата
            |   И ИндивидуальныйПланЛиквидацииЗадолженностей.Время = &Время
            |   И ИндивидуальныйПланЛиквидацииЗадолженностей.Аудитория = &Аудитория
            |   И НЕ ИндивидуальныйПланЛиквидацииЗадолженностей.ПометкаУдаления
            |   И ИндивидуальныйПланЛиквидацииЗадолженностей.Проведен = ИСТИНА";
            
            // Для документов того же типа исключаем текущий документ из проверки
            Если ТипДокумента = "ИндивидуальныйПланЛиквидацииЗадолженностей" Тогда
                Запрос.Текст = Запрос.Текст + "
                |   И ИндивидуальныйПланЛиквидацииЗадолженностей.Ссылка <> &Ссылка";
            КонецЕсли;
        КонецЕсли;
        
        Запрос.УстановитьПараметр("Дата", Дата);
        Запрос.УстановитьПараметр("Время", Время);
        Запрос.УстановитьПараметр("Аудитория", Аудитория);
        Запрос.УстановитьПараметр("Ссылка", Ссылка);
        
        Результат = Запрос.Выполнить();
        
        Если Не Результат.Пустой() Тогда
            Отказ = Истина;
            Возврат;
        КонецЕсли;
    КонецЦикла;
    
КонецПроцедуры
